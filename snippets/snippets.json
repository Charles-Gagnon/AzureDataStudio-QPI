{
    "QPI running queries": {
        "prefix": "qpi:currently running queries",
        "body": [
            "SELECT * FROM qpi.queries;"
        ],
        "description": "Return all queries that are currently in progress."
    },
    "QPI blocked queries": {
        "prefix": "qpi:blocked queries",
        "body": [
            "SELECT * FROM qpi.blocked_queries;"
        ],
        "description": "Return all queryies that are currently blocked."
    },
    "QPI query locks": {
        "prefix": "qpi:locks",
        "body": [
            "SELECT * FROM qpi.query_locks",
            "-- WHERE text = '' --> Filter using query text"
        ],
        "description": "Return all locks that the current queries are holding"
    },
    "QPI backup/restore requests": {
        "prefix": "qpi:backup/restore requests",
        "body": [
            "SELECT * FROM qpi.bre"
        ],
        "description": "Return currently active backup/restore requests"
    },
    "QPI CPU usage": {
        "prefix": "qpi:CPU usage",
        "body": [
            "SELECT * FROM qpi.cpu_usage"
        ],
        "description": "Return CPU usage"
    },
    "QPI memory usage": {
        "prefix": "qpi:memory usage",
        "body": [
            "SELECT * FROM qpi.memory"
        ],
        "description": "Return distribution of memory usage on the instance"
    },
    "QPI memory buffers": {
        "prefix": "qpi:memory buffers per db",
        "body": [
            "SELECT * FROM qpi.memory_buffers"
        ],
        "description": "Return buffer usage per database"
    },
    "QPI query statistics": {
        "prefix": "qpi:query statistics",
        "body": [
            "SELECT * FROM qpi.db_query_exec_stats",
            "-- WHERE [text] = ''",
            "-- WHERE query_id = ",
            "ORDER BY cpu_time_ms DESC --> or duration_s"
        ],
        "description": "Return query statistics from the latest Query Store interval."
    },
    "QPI query statistics(all)": {
        "prefix": "qpi:query statistics(all)",
        "body": [
            "SELECT * FROM qpi.db_query_exec_stats_history",
            "-- WHERE [text] = ''",
            "-- WHERE query_id = ",
            "ORDER BY cpu_time_ms DESC --> or duration_s"
        ],
        "description": "Return query statistics from the entire Query Store history."
    },
    "QPI query wait statistics": {
        "prefix": "qpi:query wait statistics",
        "body": [
            "SELECT * FROM qpi.db_query_wait_stats",
            "-- WHERE [text] = ''",
            "-- WHERE [category] = '' --> Buffer IO,CPU,Tran Log IO,Memory,Network IO,Parallelism,Preemptive,Idle",
            "-- WHERE query_id = ''",
            "ORDER BY duration_s DESC;"
        ],
        "description": "Return query statistics from the latest Query Store interval."
    },
    "QPI query wait statistics(all)": {
        "prefix": "qpi:query wait statistics(all)",
        "body": [
            "SELECT * FROM qpi.db_query_wait_stats_history",
            "-- WHERE [text] = ''",
            "-- WHERE [category] = '' --> Buffer IO,CPU,Tran Log IO,Memory,Network IO,Parallelism,Preemptive,Idle",
            "-- WHERE query_id = ''",
            "ORDER BY duration_s DESC;"
        ],
        "description": "Return query statistics from the entire Query Store history."
    },
    "QPI query plan statistics": {
        "prefix": "qpi:plan statistics",
        "body": [
            "SELECT * FROM qpi.db_query_plan_exec_stats",
            "-- WHERE [text] = ''",
            "-- WHERE query_id = ''",
            "-- WHERE plan_id = ''",
            "ORDER BY duration_s DESC;"
        ],
        "description": "Return query plan statistics from the latest Query Store interval."
    },
    "QPI query plan statistics (all)": {
        "prefix": "qpi:plan statistics(all)",
        "body": [
            "SELECT TOP 20 * FROM qpi.db_query_plan_exec_stats_history",
            "-- WHERE [text] = ''",
            "-- WHERE query_id = ",
            "-- WHERE plan_id = ",
            "ORDER BY duration_s DESC;"
        ],
        "description": "Return query plan wait statistics from the entire Query Store history."
    },
    "QPI query plan stats as of time": {
        "prefix": "qpi:plan statistics as of <time>",
        "body": [
            "SELECT * FROM db_query_exec_stats_as_of(",
                    "qpi.ago(0/*d*/,2/*h*/,0/*m*/),",
                ")",
            "-- WHERE query_id = ",
            "-- WHERE plan_id = "
        ],
        "description": "Return query plan statistics at the specified time in the past."
    },
    "QPI query plan compare": {
        "prefix": "qpi:compare plan statistics",
        "body": [
            "SELECT * FROM db_query_plan_exec_stats_diff(",
                    "qpi.ago(0/*d*/,2/*h*/,0/*m*/),",
                    "GETDATE()",
                ")",
            "-- WHERE query_id = ",
            "-- WHERE plan_id = "
        ],
        "description": "Return query plan wait statistics from the entire Query Store history."
    },
    "QPI query plan wait statistics": {
        "prefix": "qpi:plan wait statistics",
        "body": [
            "SELECT * FROM qpi.db_query_plan_wait_stats",
            "-- WHERE [text] = ''",
            "-- WHERE [category] = '' --> Buffer IO,CPU,Tran Log IO,Memory,Network IO,Parallelism,Preemptive,Idle",
            "-- WHERE query_id = ",
            "-- WHERE plan_id = ",
            "ORDER BY wait_time_ms DESC"
        ],
        "description": "Return query plan wait statistics from the latest Query Store interval."
    },
    "QPI snapshot statistics": {
        "prefix": "qpi:take a stat snapshot",
        "body": [
            "exec qpi.snapshot_perf_counters;",
            "exec qpi.snapshot_wait_stats;",
            "exec qpi.snapshot_file_stats;"
        ],
        "description": "take a snapshot of statistics"
    },
    "QPI execution statistics": {
        "prefix": "qpi:execution statistics",
        "body": [
            "select start_time,",
            "[type] = execution_type_desc,",
            "[queries/s] =  sum(count_executions)/ min(interval_mi) /60,",
            "[cpu %] = ROUND(100. * (sum(count_executions*cpu_time_ms) /1000.)",
            "            / ( min(interval_mi) * 60)",
            "            /  (SELECT top 1 cpu_count FROM qpi.sys_info)/*cores*/,1)",
        "from qpi.db_query_plan_exec_stats_history",
        "group by start_time, execution_type_desc",
        "order by start_time desc"
        ],
        "description": "Get the historical query execution statistics"
    },
    "QPI Queries waiting on category": {
        "prefix": "qpi:queries waiting per category",
        "body": [
            "-- Insert wait category in the where predicate:",
            "select top 100 * from qpi.db_query_wait_stats_history",
            "where category = '' --> Buffer IO,CPU,Tran Log IO,Memory,Network IO,Parallelism,Preemptive,Idle",
            "order by wait_time_ms desc"
        ],
        "description": "Find the queries that are waiting on some wait category (put the category in the query)"
    }
}